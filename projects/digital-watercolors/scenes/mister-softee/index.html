<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Loading... â€” Digital Watercolors</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŽ¨</text></svg>">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&family=DM+Sans:wght@400;500&display=swap" rel="stylesheet">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      overflow: hidden;
      background: #1a1a1a;
    }

    body {
      font-family: 'DM Sans', sans-serif;
    }

    /* Scene container with parallax */
    .scene {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      transition: transform 0.15s ease-out;
    }

    .scene canvas {
      image-rendering: pixelated;
      image-rendering: crisp-edges;
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    /* Subtle vignette */
    .vignette {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      box-shadow: inset 0 0 150px rgba(0,0,0,0.4);
      z-index: 10;
    }

    /* Scene title - fades in and out */
    .scene-title {
      position: fixed;
      bottom: 3rem;
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
      z-index: 20;
      padding: 0.75rem 1.5rem;
      background: rgba(30, 20, 10, 0.7);
      border-radius: 4px;
      opacity: 0;
      animation: fadeInOut 5s ease-in-out 0.5s forwards;
      pointer-events: none;
    }

    .scene-title h1 {
      font-family: 'Cormorant Garamond', serif;
      font-weight: 600;
      font-size: 1.3rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: #f4e4c1;
      margin-bottom: 0.15rem;
    }

    .scene-title p {
      font-family: 'Cormorant Garamond', serif;
      font-style: italic;
      font-size: 0.85rem;
      color: #c9b896;
    }

    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateX(-50%) translateY(10px); }
      15% { opacity: 1; transform: translateX(-50%) translateY(0); }
      80% { opacity: 1; transform: translateX(-50%) translateY(0); }
      100% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
    }

    /* Controls - minimal, bottom corner */
    .controls {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      display: flex;
      gap: 0.5rem;
      z-index: 100;
    }

    .control-btn {
      width: 44px;
      height: 44px;
      border: 2px solid rgba(244, 228, 193, 0.3);
      background: rgba(30, 20, 10, 0.6);
      color: #c9b896;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .control-btn:hover {
      background: rgba(30, 20, 10, 0.85);
      border-color: rgba(244, 228, 193, 0.6);
      color: #f4e4c1;
    }

    .control-btn svg {
      width: 20px;
      height: 20px;
    }

    /* Back link */
    .back-link {
      position: fixed;
      top: 1rem;
      left: 1rem;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.8rem;
      color: #c9b896;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.6rem 0.9rem;
      background: rgba(30, 20, 10, 0.6);
      border: 2px solid rgba(244, 228, 193, 0.3);
      border-radius: 4px;
      transition: all 0.2s ease;
      z-index: 100;
    }

    .back-link:hover {
      background: rgba(30, 20, 10, 0.85);
      border-color: rgba(244, 228, 193, 0.6);
      color: #f4e4c1;
    }

    /* Loading screen */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #1a1a1a;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      transition: opacity 0.6s ease, visibility 0.6s ease;
    }

    .loading-screen.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }

    /* Pixel drops */
    .loading-drops {
      display: flex;
      gap: 8px;
      margin-bottom: 1rem;
      align-items: flex-end;
    }

    .loading-drop {
      width: 8px;
      height: 12px;
      position: relative;
      animation: pixelBreathe 1600ms ease-in-out infinite;
      clip-path: polygon(
        25% 0%, 75% 0%,
        100% 25%, 100% 75%,
        75% 100%, 25% 100%,
        0% 75%, 0% 25%
      );
    }

    .loading-drop:nth-child(1) { background: #c4703f; animation-delay: 0ms; }
    .loading-drop:nth-child(2) { background: #d4845a; animation-delay: -267ms; }
    .loading-drop:nth-child(3) { background: #b8986b; animation-delay: -534ms; width: 10px; height: 14px; }
    .loading-drop:nth-child(4) { background: #8b9a7d; animation-delay: -801ms; width: 10px; height: 14px; }
    .loading-drop:nth-child(5) { background: #5a7247; animation-delay: -1068ms; }
    .loading-drop:nth-child(6) { background: #4a6a8a; animation-delay: -1335ms; }

    @keyframes pixelBreathe {
      0%, 100% { transform: translateY(0) scaleY(1); opacity: 0.7; }
      50% { transform: translateY(-6px) scaleY(1.15); opacity: 1; }
    }

    .loading-text {
      font-family: 'Cormorant Garamond', serif;
      font-style: italic;
      color: #c9b896;
      font-size: 1rem;
      margin-bottom: 0.75rem;
    }

    .loading-bar {
      width: 120px;
      height: 6px;
      background: #2a2520;
      border: 2px solid #3d3530;
      overflow: hidden;
    }

    .loading-bar-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #c4703f, #b8986b, #5a7247);
      transition: width 0.3s ease;
    }
  </style>
</head>
<body>

  <!-- Loading Screen -->
  <div class="loading-screen" id="loading-screen">
    <div class="loading-drops">
      <div class="loading-drop"></div>
      <div class="loading-drop"></div>
      <div class="loading-drop"></div>
      <div class="loading-drop"></div>
      <div class="loading-drop"></div>
      <div class="loading-drop"></div>
    </div>
    <div class="loading-text">stepping into the paintingâ€¦</div>
    <div class="loading-bar">
      <div class="loading-bar-fill" id="loading-bar-fill"></div>
    </div>
  </div>

  <div class="scene" id="scene">
    <canvas id="scene-canvas"></canvas>
  </div>

  <div class="vignette"></div>

  <div class="scene-title" id="scene-title">
    <h1 id="title-text">Loading</h1>
    <p id="subtitle-text"></p>
  </div>

  <a href="../../" class="back-link" id="back-link">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
      <path d="M19 12H5M12 19l-7-7 7-7"/>
    </svg>
    Back
  </a>

  <div class="controls">
    <button class="control-btn" id="sound-toggle" title="Toggle sound">
      <svg id="sound-on-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none;">
        <path d="M11 5L6 9H2v6h4l5 4V5z"/>
        <path d="M19.07 4.93a10 10 0 010 14.14M15.54 8.46a5 5 0 010 7.07"/>
      </svg>
      <svg id="sound-off-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M11 5L6 9H2v6h4l5 4V5z"/>
        <line x1="23" y1="9" x2="17" y2="15"/>
        <line x1="17" y1="9" x2="23" y2="15"/>
      </svg>
    </button>
  </div>

  <script>
    // ========================================
    // SCENE ENGINE - Loads from scene.json
    // ========================================
    
    const canvas = document.getElementById('scene-canvas');
    const ctx = canvas.getContext('2d');
    const sceneEl = document.getElementById('scene');
    const loadingScreen = document.getElementById('loading-screen');
    const loadingBarFill = document.getElementById('loading-bar-fill');

    const state = {
      config: null,
      frames: [],
      currentFrame: 0,
      direction: 1,
      lastFrameTime: 0,
      audioPlayers: [],
      soundEnabled: false,
      lastMouseMove: 0
    };

    // Load scene manifest
    async function loadManifest() {
      try {
        const res = await fetch('scene.json');
        state.config = await res.json();
        
        // Update page title and scene title
        document.title = `${state.config.title} â€” Digital Watercolors`;
        document.getElementById('title-text').textContent = state.config.title;
        document.getElementById('subtitle-text').textContent = state.config.subtitle || '';
        
        // Update favicon if emoji specified
        if (state.config.emoji) {
          const favicon = document.querySelector('link[rel="icon"]');
          favicon.href = `data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>${state.config.emoji}</text></svg>`;
        }
        
        return state.config;
      } catch (e) {
        console.warn('No scene.json found, using defaults');
        state.config = {
          title: 'Scene',
          subtitle: '',
          animation: { frameCount: 20, frameDelay: 120, pingPong: true },
          audio: [],
          parallax: { enabled: false }
        };
        return state.config;
      }
    }

    // Preload animation frames
    function preloadFrames() {
      const { frameCount } = state.config.animation;
      
      return new Promise((resolve, reject) => {
        if (frameCount === 0) {
          document.querySelector('.loading-text').textContent = 'waiting for frames...';
          return;
        }

        let loaded = 0;
        
        for (let i = 0; i < frameCount; i++) {
          const img = new Image();
          const frameNum = String(i).padStart(3, '0');
          img.src = `frames/frame-${frameNum}.png`;
          
          img.onload = () => {
            loaded++;
            
            // Update progress bar
            const progress = (loaded / frameCount) * 100;
            loadingBarFill.style.width = progress + '%';
            
            if (loaded === frameCount) {
              canvas.width = state.frames[0].width;
              canvas.height = state.frames[0].height;
              ctx.imageSmoothingEnabled = false;
              
              // Hide loading screen
              setTimeout(() => {
                loadingScreen.classList.add('hidden');
              }, 300);
              
              resolve();
            }
          };
          
          img.onerror = () => {
            document.querySelector('.loading-text').textContent = 'frames not found';
          };
          
          state.frames[i] = img;
        }
      });
    }

    // Animation loop
    function drawFrame() {
      const img = state.frames[state.currentFrame];
      if (!img) return;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(img, 0, 0);
    }

    function animate(timestamp) {
      const { frameDelay, pingPong, frameCount } = state.config.animation;
      
      if (timestamp - state.lastFrameTime >= frameDelay) {
        state.lastFrameTime = timestamp;
        
        state.currentFrame += state.direction;
        
        if (pingPong) {
          if (state.currentFrame >= frameCount - 1) {
            state.currentFrame = frameCount - 1;
            state.direction = -1;
          } else if (state.currentFrame <= 0) {
            state.currentFrame = 0;
            state.direction = 1;
          }
        } else {
          if (state.currentFrame >= frameCount) {
            state.currentFrame = 0;
          }
        }
        
        drawFrame();
      }
      
      requestAnimationFrame(animate);
    }

    // Parallax effect
    function initParallax() {
      if (!state.config.parallax?.enabled) return;
      
      const intensity = state.config.parallax.intensity || 0.5;
      let idleAngle = 0;
      
      // Mouse-driven parallax
      document.addEventListener('mousemove', (e) => {
        state.lastMouseMove = Date.now();
        
        const mouseX = e.clientX / window.innerWidth;
        const mouseY = e.clientY / window.innerHeight;
        
        const offsetX = (mouseX - 0.5) * 20 * intensity;
        const offsetY = (mouseY - 0.5) * 15 * intensity;
        
        sceneEl.style.transform = `translate(${offsetX}px, ${offsetY}px)`;
      });
      
      // Subtle idle drift when no mouse movement
      function idleDrift() {
        if (document.hidden) return;
        
        // Only drift if mouse hasn't moved in 2 seconds
        if (Date.now() - state.lastMouseMove > 2000) {
          idleAngle += 0.015;
          const idleX = Math.sin(idleAngle) * 4 * intensity;
          const idleY = Math.cos(idleAngle * 0.7) * 3 * intensity;
          sceneEl.style.transform = `translate(${idleX}px, ${idleY}px)`;
        }
        
        requestAnimationFrame(idleDrift);
      }
      
      requestAnimationFrame(idleDrift);
    }

    // Audio system
    function initAudio() {
      if (!state.config.audio?.length) return;
      
      state.config.audio.forEach(audioConfig => {
        const audio = new Audio(audioConfig.src);
        audio.loop = audioConfig.loop !== false;
        audio.volume = 0;
        audio.preload = 'auto';
        
        state.audioPlayers.push({
          element: audio,
          targetVolume: audioConfig.volume || 0.4
        });
      });
    }

    function toggleSound() {
      state.soundEnabled = !state.soundEnabled;
      
      const onIcon = document.getElementById('sound-on-icon');
      const offIcon = document.getElementById('sound-off-icon');
      
      if (state.soundEnabled) {
        onIcon.style.display = 'block';
        offIcon.style.display = 'none';
        
        state.audioPlayers.forEach(player => {
          player.element.play().catch(() => {});
          fadeVolume(player.element, player.targetVolume, 1000);
        });
      } else {
        onIcon.style.display = 'none';
        offIcon.style.display = 'block';
        
        state.audioPlayers.forEach(player => {
          fadeVolume(player.element, 0, 500, () => player.element.pause());
        });
      }
    }

    function fadeVolume(audio, target, duration, callback) {
      const start = audio.volume;
      const diff = target - start;
      const startTime = performance.now();
      
      function step(currentTime) {
        const elapsed = currentTime - startTime;
        const pct = Math.min(elapsed / duration, 1);
        
        audio.volume = start + (diff * pct);
        
        if (pct < 1) {
          requestAnimationFrame(step);
        } else if (callback) {
          callback();
        }
      }
      
      requestAnimationFrame(step);
    }

    // ========================================
    // INIT
    // ========================================
    document.getElementById('sound-toggle').addEventListener('click', toggleSound);
    
    loadManifest().then(() => {
      initAudio();
      initParallax();
      
      preloadFrames().then(() => {
        drawFrame();
        requestAnimationFrame(animate);
      });
    });
  </script>

</body>
</html>
