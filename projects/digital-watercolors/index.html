<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Digital Watercolors â€” Haslun Studio</title>
  <meta name="description" content="Watercolor paintings brought to life. An interactive sketchbook by Haslun Studio.">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŽ¨</text></svg>">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&family=DM+Sans:wght@400;500&display=swap" rel="stylesheet">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-dark: #1a1a1a;
      --bg-card: #242424;
      --terracotta: #c4703f;
      --terracotta-light: #d4845a;
      --text-primary: #f5f5f5;
      --text-muted: #a0a0a0;
      --pixel-shadow: #0a0a0a;
    }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    body {
      background: var(--bg-dark);
      color: var(--text-primary);
      font-family: 'DM Sans', sans-serif;
    }

    /* ========================================
       LOADING SCREEN
       ======================================== */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--bg-dark);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      transition: opacity 0.6s ease, visibility 0.6s ease;
    }

    .loading-screen.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }

    /* Pixel drops */
    .loading-drops {
      display: flex;
      gap: 8px;
      margin-bottom: 1rem;
      align-items: flex-end;
    }

    .loading-drop {
      width: 8px;
      height: 12px;
      image-rendering: pixelated;
      position: relative;
      animation: pixelBreathe 1600ms ease-in-out infinite;
      /* Pixelated drop shape via clip-path */
      clip-path: polygon(
        25% 0%, 75% 0%,
        100% 25%, 100% 75%,
        75% 100%, 25% 100%,
        0% 75%, 0% 25%
      );
    }

    .loading-drop::after {
      content: '';
      position: absolute;
      bottom: -4px;
      left: 50%;
      transform: translateX(-50%);
      width: 4px;
      height: 4px;
      background: inherit;
      opacity: 0;
      animation: pixelDrip 1600ms ease-in-out infinite;
    }

    /* Six drops - earthy watercolor palette */
    .loading-drop:nth-child(1) { 
      background: #c4703f;
      animation-delay: 0ms;
    }
    .loading-drop:nth-child(1)::after { animation-delay: 0ms; }

    .loading-drop:nth-child(2) { 
      background: #d4845a;
      animation-delay: -267ms;
    }
    .loading-drop:nth-child(2)::after { animation-delay: -267ms; }

    .loading-drop:nth-child(3) { 
      background: #b8986b;
      animation-delay: -534ms;
      width: 10px;
      height: 14px;
    }
    .loading-drop:nth-child(3)::after { animation-delay: -534ms; }

    .loading-drop:nth-child(4) { 
      background: #8b9a7d;
      animation-delay: -801ms;
      width: 10px;
      height: 14px;
    }
    .loading-drop:nth-child(4)::after { animation-delay: -801ms; }

    .loading-drop:nth-child(5) { 
      background: #5a7247;
      animation-delay: -1068ms;
    }
    .loading-drop:nth-child(5)::after { animation-delay: -1068ms; }

    .loading-drop:nth-child(6) { 
      background: #4a6a8a;
      animation-delay: -1335ms;
    }
    .loading-drop:nth-child(6)::after { animation-delay: -1335ms; }

    @keyframes pixelBreathe {
      0%, 100% {
        transform: translateY(0) scaleY(1);
        opacity: 0.7;
      }
      50% {
        transform: translateY(-6px) scaleY(1.15);
        opacity: 1;
      }
    }

    @keyframes pixelDrip {
      0%, 60%, 100% {
        opacity: 0;
        transform: translateX(-50%) translateY(0);
      }
      70% {
        opacity: 0.6;
        transform: translateX(-50%) translateY(2px);
      }
      85% {
        opacity: 0;
        transform: translateX(-50%) translateY(8px);
      }
    }

    /* Brand */
    .loading-brand {
      text-align: center;
      margin-bottom: 0.75rem;
    }

    .loading-brand-name {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.75rem;
      font-weight: 600;
      letter-spacing: 0.08em;
      color: #f4e4c1;
      text-shadow: 2px 2px 0 #1a0f05;
    }

    .loading-brand-sub {
      font-family: 'DM Sans', sans-serif;
      font-size: 0.65rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: #8a7a5a;
      margin-top: 0.2rem;
    }

    /* Pixel progress bar */
    .loading-bar {
      width: 120px;
      height: 6px;
      background: #2a2520;
      border: 2px solid #3d3530;
      position: relative;
      overflow: hidden;
    }

    .loading-bar-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, 
        #c4703f 0%, 
        #d4845a 20%, 
        #b8986b 40%, 
        #8b9a7d 70%, 
        #5a7247 100%
      );
      transition: width 0.3s ease;
    }

    .loading-tagline {
      font-family: 'Cormorant Garamond', serif;
      font-style: italic;
      font-size: 0.85rem;
      color: #6a5a4a;
      margin-top: 0.75rem;
    }

    /* Animated Background */
    .background-animation {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .background-animation canvas {
      image-rendering: pixelated;
      image-rendering: crisp-edges;
      height: 100%;
      width: auto;
      max-width: none;
    }

    /* ========================================
       HERO OVERLAY + WINDOW
       ======================================== */
    .hero-overlay {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      perspective: 1200px;
      z-index: 2;
    }

    /* Vignette behind window */
    .hero-overlay::before {
      content: "";
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at center,
        rgba(0,0,0,0.0) 0%,
        rgba(0,0,0,0.25) 50%,
        rgba(0,0,0,0.6) 100%);
      pointer-events: none;
    }

    .hero-window {
      pointer-events: auto;
      transform-style: preserve-3d;
      transform: translate3d(0, 0, 0);
      max-width: min(420px, 90vw);
      transition: transform 0.08s ease-out;
      image-rendering: pixelated;
    }

    /* Pixel scrim behind menu for readability */
    .hero-window::before {
      content: "";
      position: absolute;
      inset: -16px;
      z-index: -1;
      background:
        radial-gradient(circle at 50% 40%, rgba(0,0,0,0.3), rgba(0,0,0,0.6)),
        linear-gradient(45deg, 
          rgba(255,255,255,0.04) 25%, transparent 25% 50%, 
          rgba(255,255,255,0.04) 50% 75%, transparent 75%
        ) 0 0/8px 8px;
      box-shadow: 0 0 0 4px rgba(0,0,0,0.5);
    }

    /* Pixel-panel base styles */
    .hero-header,
    .hero-menu {
      position: relative;
      /* Dithered fill instead of glass blur */
      background:
        linear-gradient(45deg, 
          rgba(0,0,0,0.15) 25%, transparent 25% 50%, 
          rgba(0,0,0,0.15) 50% 75%, transparent 75%
        ) 0 0/6px 6px,
        linear-gradient(to bottom, rgba(255,255,255,0.06), rgba(255,255,255,0) 30%),
        linear-gradient(to bottom, rgba(28, 18, 10, 0.96), rgba(22, 14, 8, 0.94));
      background-color: rgba(22, 12, 6, 0.95);
      image-rendering: pixelated;
    }

    /* Chunky pixel border via layered box-shadows */
    .hero-header {
      padding: 1.25rem 2rem 1rem;
      border: none;
      box-shadow:
        /* outer dark outline */
        0 0 0 4px #0a0604,
        /* gold mid-border */
        0 0 0 8px #a08050,
        /* inner highlight */
        0 0 0 10px rgba(255,255,255,0.08),
        /* inner shadow for depth */
        inset 0 -1px 0 rgba(0,0,0,0.4);
    }

    .hero-menu {
      padding: 0;
      border: none;
      box-shadow:
        /* outer dark outline */
        0 0 0 4px #0a0604,
        /* gold mid-border */
        0 0 0 8px #a08050,
        /* inner highlight */
        0 0 0 10px rgba(255,255,255,0.08),
        /* blocky drop shadow */
        10px 10px 0 0 rgba(0,0,0,0.35),
        /* inner shadow for depth */
        inset 0 1px 0 rgba(0,0,0,0.5);
      margin-top: -4px; /* connect to header */
    }

    /* Pixel corner accents */
    .hero-header::before {
      content: "";
      position: absolute;
      width: 6px;
      height: 6px;
      background: #c9a86c;
      top: 6px;
      left: 6px;
      box-shadow:
        calc(100% - 12px) 0 0 #c9a86c,
        0 0 0 1px rgba(0,0,0,0.5),
        calc(100% - 12px) 0 0 1px rgba(0,0,0,0.5);
    }

    .hero-menu::before {
      content: "";
      position: absolute;
      width: 6px;
      height: 6px;
      background: #c9a86c;
      bottom: 6px;
      left: 6px;
      box-shadow:
        calc(100% - 12px) 0 0 #c9a86c,
        0 0 0 1px rgba(0,0,0,0.5),
        calc(100% - 12px) 0 0 1px rgba(0,0,0,0.5);
    }

    /* Remove old ::after pseudo-elements */
    .hero-header::after,
    .hero-menu::after {
      display: none;
    }

    /* Title typography */
    .hero-title {
      margin: 0;
      font-family: 'Cormorant Garamond', serif;
      font-weight: 600;
      font-size: clamp(1.1rem, 2.8vw, 1.4rem);
      letter-spacing: 0.18em;
      text-transform: uppercase;
      text-align: center;
      color: #fef5e3;
      /* Pixel-style text shadow */
      text-shadow:
        2px 2px 0 rgba(0,0,0,0.9),
        -1px -1px 0 rgba(0,0,0,0.3);
    }

    .hero-subtitle {
      margin: 0.4rem 0 0;
      font-family: 'Cormorant Garamond', serif;
      font-style: italic;
      font-size: 0.9rem;
      text-align: center;
      color: rgba(250,235,200,0.8);
      letter-spacing: 0.08em;
      text-shadow: 2px 2px 0 rgba(0,0,0,0.8);
    }

    /* Menu panel styles */
    .menu-header {
      background:
        linear-gradient(45deg, 
          rgba(0,0,0,0.1) 25%, transparent 25% 50%, 
          rgba(0,0,0,0.1) 50% 75%, transparent 75%
        ) 0 0/4px 4px,
        linear-gradient(180deg, rgba(100,70,35,0.95) 0%, rgba(60,42,22,0.98) 100%);
      padding: 0.5rem 1rem;
      border-top: 2px solid rgba(0,0,0,0.6);
      border-bottom: 2px solid rgba(0,0,0,0.4);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.08);
    }

    .menu-header h2 {
      font-family: 'DM Sans', sans-serif;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: #d4c4a4;
      text-shadow: 2px 2px 0 rgba(0,0,0,0.7);
      margin: 0;
      text-align: center;
    }

    .menu-section {
      padding: 0.6rem 0.75rem;
      /* Pixel-style dashed border */
      border-bottom: 2px dashed rgba(100,80,50,0.4);
    }

    .menu-section:last-child {
      border-bottom: none;
    }

    .menu-section-label {
      font-family: 'DM Sans', sans-serif;
      font-size: 0.6rem;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: rgba(200,180,140,0.7);
      margin-bottom: 0.35rem;
      padding-left: 0.5rem;
      font-weight: 500;
      text-shadow: 1px 1px 0 rgba(0,0,0,0.5);
    }

    .menu-items {
      display: flex;
      gap: 4px;
      flex-direction: column;
    }

    .menu-item {
      position: relative;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.85rem;
      font-weight: 500;
      color: #e8dcc8;
      text-decoration: none;
      padding: 0.5rem 0.7rem 0.5rem 1.6rem;
      /* Pixel-style button background */
      background:
        linear-gradient(to bottom, rgba(160,128,80,0.12), rgba(160,128,80,0.06));
      /* Chunky pixel border */
      border: none;
      box-shadow:
        0 0 0 2px #0a0604,
        0 0 0 4px rgba(100,80,50,0.7);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      text-shadow: 2px 2px 0 rgba(0,0,0,0.8);
      transition: none; /* Pixel feel = no smooth transitions */
    }

    /* Arrow indicator on hover/focus */
    .menu-item::before {
      content: 'â–¶';
      position: absolute;
      left: 0.5rem;
      font-size: 0.5rem;
      color: #c9a86c;
      opacity: 0;
      text-shadow: 1px 1px 0 #000;
    }

    .menu-item:hover,
    .menu-item:focus-visible {
      outline: none;
      color: #fff;
      background:
        linear-gradient(to bottom, rgba(180,140,60,0.25), rgba(180,140,60,0.12));
      box-shadow:
        0 0 0 2px #0a0604,
        0 0 0 4px #c9a86c,
        0 0 0 6px rgba(200,100,40,0.4);
    }

    .menu-item:hover::before,
    .menu-item:focus-visible::before {
      opacity: 1;
      animation: pixelBob 600ms steps(2, end) infinite;
    }

    .menu-item:active {
      transform: translate(2px, 2px);
      box-shadow:
        0 0 0 2px #0a0604,
        0 0 0 4px #c9a86c;
    }

    @keyframes pixelBob {
      0%, 100% { transform: translateX(0); }
      50% { transform: translateX(2px); }
    }

    .menu-item.disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .menu-item.disabled:hover {
      background: linear-gradient(to bottom, rgba(160,128,80,0.12), rgba(160,128,80,0.06));
      box-shadow:
        0 0 0 2px #0a0604,
        0 0 0 4px rgba(100,80,50,0.7);
      color: #e8dcc8;
    }

    .menu-item.disabled:hover::before {
      opacity: 0;
    }

    .coming-soon {
      font-size: 0.6rem;
      color: rgba(200,180,140,0.5);
      font-style: italic;
      margin-left: auto;
      text-shadow: 1px 1px 0 rgba(0,0,0,0.6);
    }

    .menu-item.scene-link {
      background:
        linear-gradient(to bottom, rgba(180,140,60,0.15), rgba(180,140,60,0.08));
    }

    .menu-item.scene-link:hover {
      background:
        linear-gradient(to bottom, rgba(180,140,60,0.25), rgba(180,140,60,0.12));
    }

    /* Footer - pixel style */
    .footer {
      position: fixed;
      bottom: 1rem;
      left: 50%;
      transform: translateX(-50%);
      z-index: 2;
      text-align: center;
      padding: 0.4rem 1rem;
      background:
        linear-gradient(45deg, 
          rgba(0,0,0,0.1) 25%, transparent 25% 50%, 
          rgba(0,0,0,0.1) 50% 75%, transparent 75%
        ) 0 0/4px 4px,
        rgba(22, 12, 6, 0.9);
      box-shadow:
        0 0 0 2px #0a0604,
        0 0 0 4px rgba(100,80,50,0.6);
    }

    .footer p {
      font-family: 'Cormorant Garamond', serif;
      font-style: italic;
      font-size: 0.75rem;
      color: rgba(200,180,140,0.8);
      margin: 0;
      text-shadow: 1px 1px 0 rgba(0,0,0,0.6);
    }

    .footer a {
      color: #c9a86c;
      text-decoration: none;
    }

    .footer a:hover {
      color: #e8dcc8;
    }

    /* Hero window entrance animation */
    @keyframes pixelOpen {
      0% {
        opacity: 0;
        transform: translate3d(0, 0, 0) scale(0.9);
      }
      100% {
        opacity: 1;
        transform: translate3d(0, 0, 0) scale(1);
      }
    }

    .hero-window {
      animation: pixelOpen 300ms steps(6, end) forwards;
    }

    /* ========================================
       ATMOSPHERE SYSTEM (Pigment Engine)
       ======================================== */
    
    /* Living wash overlay - sits between background and UI */
    .wash-overlay {
      position: fixed;
      inset: 0;
      z-index: 1;
      pointer-events: none;
      opacity: 0;
      transition: opacity 8s ease-in-out, background-color 8s ease-in-out;
      mix-blend-mode: multiply;
    }

    .wash-overlay.active {
      opacity: 0.08;
    }

    /* Scene transition wash */
    .transition-wash {
      position: fixed;
      inset: 0;
      z-index: 1000;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.6s ease-in-out;
    }

    .transition-wash.entering {
      opacity: 0.85;
      transition: opacity 0.4s ease-in;
    }

    .transition-wash.leaving {
      opacity: 0;
      transition: opacity 0.5s ease-out;
    }

    /* Daily accent - CSS custom properties set by engine */
    :root {
      --daily-accent: #c9a86c;
      --daily-accent-light: #d4b87a;
      --daily-wash: rgba(200, 168, 108, 0.1);
    }

    /* Responsive */
    @media (max-width: 600px) {
      .hero-window {
        max-width: 92vw;
      }

      .hero-window::before {
        inset: -10px;
      }

      .hero-header {
        padding: 1rem 1.25rem 0.75rem;
      }

      .hero-title {
        font-size: 1.1rem;
        letter-spacing: 0.12em;
      }

      .hero-subtitle {
        font-size: 0.8rem;
      }
      
      .menu-header h2 {
        font-size: 0.65rem;
      }
      
      .menu-item {
        font-size: 0.8rem;
        padding: 0.4rem 0.5rem 0.4rem 1.4rem;
      }
    }

    /* Respect reduced-motion preference */
    @media (prefers-reduced-motion: reduce) {
      .hero-window {
        transform: none !important;
        transition: none !important;
        animation: none !important;
      }
      
      .loading-drop,
      .loading-drop::after,
      .menu-item::before {
        animation: none !important;
      }
    }

    /* iOS motion permission button - pixel style */
    .motion-permission {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      z-index: 100;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.7rem;
      font-weight: 500;
      letter-spacing: 0.08em;
      color: #d4c4a4;
      background:
        linear-gradient(45deg, 
          rgba(0,0,0,0.1) 25%, transparent 25% 50%, 
          rgba(0,0,0,0.1) 50% 75%, transparent 75%
        ) 0 0/4px 4px,
        rgba(22, 12, 6, 0.95);
      border: none;
      box-shadow:
        0 0 0 2px #0a0604,
        0 0 0 4px #a08050;
      padding: 0.5rem 0.8rem;
      cursor: pointer;
      text-shadow: 1px 1px 0 rgba(0,0,0,0.6);
    }

    .motion-permission:hover {
      color: #fef5e3;
      box-shadow:
        0 0 0 2px #0a0604,
        0 0 0 4px #c9a86c,
        0 0 0 6px rgba(200,100,40,0.3);
    }

    .motion-permission:active {
      transform: translate(2px, 2px);
      box-shadow:
        0 0 0 2px #0a0604,
        0 0 0 4px #c9a86c;
    }
  </style>
</head>
<body>

  <!-- Loading Screen -->
  <div class="loading-screen" id="loading-screen">
    <div class="loading-drops">
      <div class="loading-drop"></div>
      <div class="loading-drop"></div>
      <div class="loading-drop"></div>
      <div class="loading-drop"></div>
      <div class="loading-drop"></div>
      <div class="loading-drop"></div>
    </div>
    <div class="loading-brand">
      <div class="loading-brand-name">Digital Watercolors</div>
      <div class="loading-brand-sub">Haslun Studio</div>
    </div>
    <div class="loading-bar">
      <div class="loading-bar-fill" id="loading-bar-fill"></div>
    </div>
    <div class="loading-tagline">paintings that breathe</div>
  </div>

  <div class="background-animation">
    <canvas id="bg-canvas"></canvas>
  </div>

  <!-- Atmosphere: Living wash overlay (pigment engine) -->
  <div class="wash-overlay" id="wash-overlay"></div>
  
  <!-- Atmosphere: Scene transition wash -->
  <div class="transition-wash" id="transition-wash"></div>

  <!-- Hero Overlay with 3D parallax -->
  <div class="hero-overlay" id="hero-overlay">
    <div class="hero-window" id="hero-window">
      <header class="hero-header">
        <h1 class="hero-title">Digital Watercolors</h1>
        <p class="hero-subtitle">Paintings that breathe</p>
      </header>

      <section class="hero-menu">
        <div class="menu-header">
          <h2>âœ¦ Menu âœ¦</h2>
        </div>
        
        <!-- Scenes section - populated by JavaScript -->
        <div class="menu-section" id="scenes-section" style="display: none;">
          <div class="menu-section-label">Scenes</div>
          <div class="menu-items" id="scenes-menu"></div>
        </div>

        <!-- Static links -->
        <div class="menu-section">
          <div class="menu-section-label">Studio</div>
          <div class="menu-items">
            <a href="https://haslun.studio" class="menu-item" target="_blank">Gallery</a>
            <a href="https://haslun.studio/#prints" class="menu-item" target="_blank">Shop Prints</a>
            <a href="https://haslun.studio/watercolor-lab.html" class="menu-item" target="_blank">Color Lab</a>
          </div>
        </div>
      </section>
    </div>
  </div>

  <div class="footer">
    <p>Watercolors by <a href="https://haslun.studio" target="_blank">Haslun Studio</a></p>
  </div>

  <!-- Load scenes config and watercolor engine -->
  <script src="scenes.js"></script>
  <script src="watercolor-engine/watercolor-engine.js"></script>
  
  <script>
    // ========================================
    // ATMOSPHERE SYSTEM (Pigment Engine)
    // Silent infrastructure - colors are felt, not announced
    // ========================================
    const Atmosphere = {
      engine: null,
      washOverlay: null,
      transitionWash: null,
      currentWashIndex: 0,
      washInterval: null,
      
      // Pigments suitable for ambient washes (transparent/semi-transparent only)
      glazingPigments: [],
      
      init() {
        if (typeof WatercolorEngine === 'undefined') {
          console.warn('Watercolor engine not loaded, atmosphere disabled');
          return;
        }
        
        this.engine = new WatercolorEngine();
        this.washOverlay = document.getElementById('wash-overlay');
        this.transitionWash = document.getElementById('transition-wash');
        this.glazingPigments = this.engine.getGlazingPigments();
        
        // Set daily accent colors
        this.setDailyAccent();
        
        // Start living washes after a delay
        setTimeout(() => this.startLivingWashes(), 3000);
      },
      
      // ----------------------------------------
      // DAILY GENERATIVE SWATCH
      // Deterministic palette based on date
      // ----------------------------------------
      getDailySeed() {
        const now = new Date();
        // Create seed from year + day of year
        const start = new Date(now.getFullYear(), 0, 0);
        const diff = now - start;
        const dayOfYear = Math.floor(diff / (1000 * 60 * 60 * 24));
        return now.getFullYear() * 1000 + dayOfYear;
      },
      
      seededRandom(seed) {
        // Simple seeded PRNG (mulberry32)
        return function() {
          let t = seed += 0x6D2B79F5;
          t = Math.imul(t ^ t >>> 15, t | 1);
          t ^= t + Math.imul(t ^ t >>> 7, t | 61);
          return ((t ^ t >>> 14) >>> 0) / 4294967296;
        };
      },
      
      setDailyAccent() {
        const seed = this.getDailySeed();
        const random = this.seededRandom(seed);
        
        // Pick 2-3 pigments for today
        const count = 2 + Math.floor(random() * 2); // 2 or 3
        const todaysPigments = [];
        const available = [...this.glazingPigments];
        
        for (let i = 0; i < count && available.length > 0; i++) {
          const idx = Math.floor(random() * available.length);
          todaysPigments.push(available.splice(idx, 1)[0]);
        }
        
        if (todaysPigments.length === 0) return;
        
        // Glaze them together
        const glazed = this.engine.glazeMultiple(todaysPigments);
        const glazedLight = this.engine.lerp(this.engine.paperWhite, glazed, 0.6);
        const glazedWash = this.engine.lerp(this.engine.paperWhite, glazed, 0.15);
        
        // Set CSS custom properties
        document.documentElement.style.setProperty('--daily-accent', glazed);
        document.documentElement.style.setProperty('--daily-accent-light', glazedLight);
        document.documentElement.style.setProperty('--daily-wash', glazedWash);
        
        // Store for other uses
        this.dailyPalette = {
          pigments: todaysPigments,
          glazed,
          glazedLight,
          glazedWash
        };
      },
      
      // ----------------------------------------
      // LIVING BACKGROUND WASHES
      // Subtle, breathing color shifts
      // ----------------------------------------
      startLivingWashes() {
        if (!this.washOverlay || this.glazingPigments.length === 0) return;
        
        // Initial wash
        this.applyNextWash();
        
        // Cycle every 25-40 seconds
        const cycleTime = 25000 + Math.random() * 15000;
        this.washInterval = setInterval(() => {
          this.applyNextWash();
        }, cycleTime);
      },
      
      applyNextWash() {
        if (!this.washOverlay) return;
        
        // Pick 1-2 transparent pigments
        const count = 1 + Math.floor(Math.random() * 2);
        const pigments = [];
        
        for (let i = 0; i < count; i++) {
          const idx = Math.floor(Math.random() * this.glazingPigments.length);
          pigments.push(this.glazingPigments[idx]);
        }
        
        // Glaze over paper white
        const washColor = this.engine.glazeMultiple(pigments);
        
        // Apply with very low opacity (handled by CSS)
        this.washOverlay.style.backgroundColor = washColor;
        this.washOverlay.classList.add('active');
      },
      
      // ----------------------------------------
      // SCENE TRANSITION WASHES
      // Called when navigating between scenes
      // ----------------------------------------
      
      // Pigment associations for different moods/destinations
      transitionPalettes: {
        warm: ['Indian Yellow', 'Yellow Ochre', 'Orange'],
        cool: ['Ultramarine', 'Prussian Blue', "Payne's Grey"],
        earth: ['Burnt Umber', 'Sepia', 'Yellow Ochre'],
        vibrant: ['Magenta', 'Cyan', 'Brilliant Green'],
        neutral: ["Payne's Grey", 'Sepia']
      },
      
      async transitionTo(destination, mood = 'neutral') {
        if (!this.transitionWash || !this.engine) {
          // Fallback: just navigate
          window.location.href = destination;
          return;
        }
        
        // Pick pigment based on mood
        const palette = this.transitionPalettes[mood] || this.transitionPalettes.neutral;
        const pigmentName = palette[Math.floor(Math.random() * palette.length)];
        const pigment = this.engine.findPigment(pigmentName);
        
        if (pigment) {
          const washColor = this.engine.glaze(this.engine.paperWhite, pigment);
          this.transitionWash.style.backgroundColor = washColor;
        }
        
        // Animate in
        this.transitionWash.classList.add('entering');
        
        // Navigate after wash covers screen
        await new Promise(resolve => setTimeout(resolve, 400));
        window.location.href = destination;
      },
      
      // For incoming transitions (call on page load)
      transitionIn() {
        if (!this.transitionWash) return;
        
        // If we arrived via transition, fade out the wash
        this.transitionWash.classList.remove('entering');
        this.transitionWash.classList.add('leaving');
        
        setTimeout(() => {
          this.transitionWash.classList.remove('leaving');
        }, 600);
      }
    };

    // ========================================
    // HUB ANIMATION
    // ========================================
    const hubConfig = {
      frameCount: 20,
      framePath: 'hub-frames/frame-',
      frameExtension: '.png',
      frameDelay: 120,
      pingPong: true
    };

    const canvas = document.getElementById('bg-canvas');
    const ctx = canvas.getContext('2d');
    const loadingScreen = document.getElementById('loading-screen');
    const loadingBarFill = document.getElementById('loading-bar-fill');

    const state = {
      frames: [],
      currentFrame: 0,
      direction: 1,
      lastFrameTime: 0,
      loaded: 0
    };

    function preloadFrames() {
      return new Promise((resolve) => {
        for (let i = 0; i < hubConfig.frameCount; i++) {
          const img = new Image();
          const frameNum = String(i).padStart(3, '0');
          img.src = `${hubConfig.framePath}${frameNum}${hubConfig.frameExtension}`;
          
          img.onload = () => {
            state.loaded++;
            
            // Update progress bar
            const progress = (state.loaded / hubConfig.frameCount) * 100;
            loadingBarFill.style.width = progress + '%';
            
            if (state.loaded === hubConfig.frameCount) {
              canvas.width = state.frames[0].width;
              canvas.height = state.frames[0].height;
              ctx.imageSmoothingEnabled = false;
              
              // Hide loading screen after brief delay
              setTimeout(() => {
                loadingScreen.classList.add('hidden');
              }, 400);
              
              resolve();
            }
          };
          
          state.frames[i] = img;
        }
      });
    }

    function drawFrame() {
      const img = state.frames[state.currentFrame];
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(img, 0, 0);
    }

    function animate(timestamp) {
      if (timestamp - state.lastFrameTime >= hubConfig.frameDelay) {
        state.lastFrameTime = timestamp;
        
        state.currentFrame += state.direction;
        
        if (state.currentFrame >= hubConfig.frameCount - 1) {
          state.currentFrame = hubConfig.frameCount - 1;
          state.direction = -1;
        } else if (state.currentFrame <= 0) {
          state.currentFrame = 0;
          state.direction = 1;
        }
        
        drawFrame();
      }
      
      requestAnimationFrame(animate);
    }

    // ========================================
    // BUILD SCENES MENU FROM CONFIG
    // ========================================
    function buildScenesMenu() {
      if (typeof SCENES === 'undefined' || SCENES.length === 0) return;
      
      const section = document.getElementById('scenes-section');
      const menu = document.getElementById('scenes-menu');
      
      SCENES.forEach(scene => {
        const item = document.createElement('a');
        item.className = 'menu-item scene-link' + (scene.ready ? '' : ' disabled');
        item.href = scene.ready ? `scenes/${scene.id}/` : '#';
        item.innerHTML = scene.label;
        
        if (!scene.ready) {
          item.innerHTML += '<span class="coming-soon">soon</span>';
          item.onclick = (e) => e.preventDefault();
        } else {
          // Use transition wash for scene navigation
          item.onclick = (e) => {
            e.preventDefault();
            const mood = scene.mood || 'neutral'; // scenes can define mood
            Atmosphere.transitionTo(item.href, mood);
          };
        }
        
        menu.appendChild(item);
      });
      
      section.style.display = 'block';
    }

    // ========================================
    // 3D PARALLAX FOR HERO WINDOW
    // ========================================
    function initHeroParallax() {
      const heroOverlay = document.getElementById('hero-overlay');
      const heroWindow = document.getElementById('hero-window');
      
      if (!heroOverlay || !heroWindow) return;
      
      // Respect reduced-motion preference
      if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
        return;
      }
      
      const maxRotate = 8;   // degrees
      const maxShift = 18;   // pixels

      function applyParallax(xNorm, yNorm) {
        const rotateY = (xNorm - 0.5) * -2 * maxRotate;
        const rotateX = (yNorm - 0.5) * 2 * maxRotate;
        const translateX = (xNorm - 0.5) * 2 * maxShift;
        const translateY = (yNorm - 0.5) * 2 * maxShift;

        heroWindow.style.transform = 
          `translate3d(${translateX}px, ${translateY}px, 0) ` +
          `rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
      }
      
      function setupDeviceOrientation() {
        window.addEventListener('deviceorientation', (e) => {
          if (e.gamma === null && e.beta === null) return;
          const xNorm = (e.gamma + 45) / 90;  // gamma: -45 to 45
          const yNorm = (e.beta - 30) / 60;   // beta: 0 to 60
          applyParallax(
            Math.min(1, Math.max(0, xNorm)),
            Math.min(1, Math.max(0, yNorm))
          );
        }, { passive: true });
      }

      // Desktop: pointer/mouse movement
      window.addEventListener('pointermove', (e) => {
        const rect = heroOverlay.getBoundingClientRect();
        const xNorm = (e.clientX - rect.left) / rect.width;
        const yNorm = (e.clientY - rect.top) / rect.height;
        applyParallax(xNorm, yNorm);
      });

      // Mobile: device tilt (iOS requires permission)
      if (typeof DeviceOrientationEvent !== 'undefined' &&
          typeof DeviceOrientationEvent.requestPermission === 'function') {
        // iOS 13+ requires permission - show button
        const btn = document.createElement('button');
        btn.textContent = 'âœ¦ Enable tilt âœ¦';
        btn.className = 'motion-permission';
        btn.setAttribute('aria-label', 'Enable device motion for parallax effect');
        document.body.appendChild(btn);

        btn.onclick = async () => {
          try {
            const permission = await DeviceOrientationEvent.requestPermission();
            if (permission === 'granted') {
              setupDeviceOrientation();
              btn.remove();
            }
          } catch (err) {
            console.log('Motion permission denied:', err);
            btn.remove();
          }
        };
      } else if ('DeviceOrientationEvent' in window) {
        // Android and other devices - just attach listener
        setupDeviceOrientation();
      }

      // Reset on mouse leave
      heroOverlay.addEventListener('mouseleave', () => {
        heroWindow.style.transform = 'translate3d(0, 0, 0) rotateX(0deg) rotateY(0deg)';
      });
    }

    // ========================================
    // INIT
    // ========================================
    buildScenesMenu();
    initHeroParallax();
    
    // Initialize atmosphere (pigment engine)
    Atmosphere.init();
    
    preloadFrames().then(() => {
      drawFrame();
      requestAnimationFrame(animate);
      
      // Fade in transition if arriving from another page
      Atmosphere.transitionIn();
    });
  </script>

</body>
</html>
